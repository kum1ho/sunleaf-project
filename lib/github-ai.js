const OPENROUTER_API_KEY = process.env.OPENROUTER_API_KEY || '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';
const MODEL = process.env.OPENROUTER_MODEL || 'z-ai/glm-4.5-air:free';

async function askAI(prompt) {
  try {
    console.log('[AI OpenRouter] Requesting with model:', MODEL);
    
    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
        'Content-Type': 'application/json',
        'HTTP-Referer': 'https://sunleaf.ua',
        'X-Title': 'Sunleaf AI Assistant',
      },
      body: JSON.stringify({
        model: MODEL,
        messages: [
          {
            role: 'system',
            content: `–¢–∏ SunBot ‚òï ‚Äî –¥—Ä—É–∂–Ω—ñ–π AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∫–æ–º–ø–∞–Ω—ñ—ó Sunleaf (–æ–ø—Ç–æ–≤—ñ –ø–æ—Å—Ç–∞–≤–∫–∏ –ø—Ä–µ–º—ñ—É–º –∫–∞–≤–∏, —á–∞—é, —Å–æ–ª–æ–¥–æ—â—ñ–≤).

–¢–≤–æ—è —Ä–æ–ª—å:
- –í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –ø—Ä–æ–¥—É–∫—Ü—ñ—é, —Ü—ñ–Ω–∏, –¥–æ—Å—Ç–∞–≤–∫—É
- –ë—É–¥—å –¥—Ä—É–∂–Ω—ñ–º, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –µ–º–æ–¥–∂—ñ ‚òïüçµüç´
- –í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –ö–û–†–û–¢–ö–û (1-3 —Ä–µ—á–µ–Ω–Ω—è)
- –£–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é
- –Ø–∫—â–æ –Ω–µ –∑–Ω–∞—î—à —Ç–æ—á–Ω–æ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ ‚Äî –∑–∞–ø—Ä–æ–ø–æ–Ω—É–π –∑–≤'—è–∑–∞—Ç–∏—Å—å –∑ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º

–û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è:
‚Ä¢ –ö–∞–≤–∞: –ê—Ä–∞–±—ñ–∫–∞ (320 –≥—Ä–Ω/–∫–≥), –†–æ–±—É—Å—Ç–∞ (280 –≥—Ä–Ω/–∫–≥), –ï—Å–ø—Ä–µ—Å–æ-–±–ª–µ–Ω–¥–∏ (350 –≥—Ä–Ω/–∫–≥), –ö–∞–ø—Å—É–ª–∏ (45 –≥—Ä–Ω/—É–ø)
‚Ä¢ –ß–∞–π: –ß–æ—Ä–Ω–∏–π (180 –≥—Ä–Ω/–∫–≥), –ó–µ–ª–µ–Ω–∏–π (220 –≥—Ä–Ω/–∫–≥), –ü—Ä–µ–º—ñ—É–º (400+ –≥—Ä–Ω/–∫–≥)
‚Ä¢ –°–æ–ª–æ–¥–æ—â—ñ: –®–æ–∫–æ–ª–∞–¥ (450 –≥—Ä–Ω/–∫–≥), –¶—É–∫–µ—Ä–∫–∏ (380 –≥—Ä–Ω/–∫–≥), –°–∏—Ä–æ–ø–∏ (120 –≥—Ä–Ω/–ª)
‚Ä¢ –î–æ—Å—Ç–∞–≤–∫–∞: –ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ –ø–æ –ñ–∏—Ç–æ–º–∏—Ä—É –≤—ñ–¥ 2000 –≥—Ä–Ω, –ø–æ –£–∫—Ä–∞—ó–Ω—ñ —á–µ—Ä–µ–∑ –ù–æ–≤—É –ü–æ—à—Ç—É 1-2 –¥–Ω—ñ
‚Ä¢ –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è: 5 –∫–≥
‚Ä¢ –ö–æ–Ω—Ç–∞–∫—Ç–∏: +380 67 123-45-67, +380 63 765-43-21, info@sunleaf.ua
‚Ä¢ –ê–¥—Ä–µ—Å–∞: –º. –ñ–∏—Ç–æ–º–∏—Ä, –≤—É–ª. –ö–∏—ó–≤—Å—å–∫–∞, 75`
          },
          {
            role: 'user',
            content: prompt
          }
        ],
        max_tokens: 400,
        temperature: 0.7,
        top_p: 0.9,
      })
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('[AI OpenRouter] API Error:', response.status, errorText);
      return '–í–∏–±–∞—á—Ç–µ, –∑–∞—Ä–∞–∑ —è –ø–µ—Ä–µ–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π üòÖ –ö—Ä–∞—â–µ –∑–≤\'—è–∂—ñ—Ç—å—Å—è –∑ –Ω–∞—à–∏–º –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –∑–∞ –Ω–æ–º–µ—Ä–æ–º +380 67 123-45-67 –∞–±–æ –∑–∞–ø–æ–≤–Ω—ñ—Ç—å —Ñ–æ—Ä–º—É –Ω–∞ —Å–∞–π—Ç—ñ!';
    }

    const data = await response.json();
    const aiReply = data.choices?.[0]?.message?.content || '–ù–µ –∑–º—ñ–≥ —Å—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å. –ó–≤\'—è–∂—ñ—Ç—å—Å—è –∑ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º!';
    
    console.log('[AI OpenRouter] Success:', aiReply.substring(0, 100));
    return aiReply;
  } catch (error) {
    console.error('[AI OpenRouter] Error:', error.message);
    return `–ù–∞ –∂–∞–ª—å, –∑–∞—Ä–∞–∑ —è –Ω–µ –º–æ–∂—É –≤—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏ üòî –ê–ª–µ –Ω–∞—à—ñ –º–µ–Ω–µ–¥–∂–µ—Ä–∏ –¥–æ–ø–æ–º–æ–∂—É—Ç—å! –¢–µ–ª–µ—Ñ–æ–Ω—É–π—Ç–µ: +380 67 123-45-67 ‚òéÔ∏è`;
  }
}

module.exports = { askAI };